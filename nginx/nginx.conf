worker_processes auto;

events { worker_connections 1024; }

http {
    resolver 1.1.1.1 valid=30s;

    # Servers for each port
    upstream backend_99 {
        random;
        server a.imzami.com:99 max_fails=3 fail_timeout=10s;
        server b.imzami.com:99 max_fails=3 fail_timeout=10s;
    }
    upstream backend_98 {
        random;
        server a.imzami.com:98 max_fails=3 fail_timeout=10s;
        server b.imzami.com:98 max_fails=3 fail_timeout=10s;
    }
    upstream backend_500 {
        random;
        server a.imzami.com:500 max_fails=3 fail_timeout=10s;
        server b.imzami.com:500 max_fails=3 fail_timeout=10s;
    }
    upstream backend_4500 {
        random;
        server a.imzami.com:4500 max_fails=3 fail_timeout=10s;
        server b.imzami.com:4500 max_fails=3 fail_timeout=10s;
    }

    server {
        listen 99;
        server_name proxy.imzami.com;
        location / { proxy_pass http://backend_99; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    }
    server {
        listen 98;
        server_name proxy.imzami.com;
        location / { proxy_pass http://backend_98; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    }
    server {
        listen 500;
        server_name proxy.imzami.com;
        location / { proxy_pass http://backend_500; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    }
    server {
        listen 4500;
        server_name proxy.imzami.com;
        location / { proxy_pass http://backend_4500; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    }
}
