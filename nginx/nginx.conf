worker_processes auto;

events { worker_connections 1024; }

http {
    resolver 1.1.1.1 valid=30s;

    # Redirect HTTP to HTTPS for all ports
    server {
        listen 80;
        server_name proxy.imzami.com;
        location /.well-known/acme-challenge/ {
            root /var/www/html;
        }
        location / {
            return 301 https://$host$request_uri;
        }
    }

    ssl_certificate /etc/letsencrypt/live/proxy.imzami.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/proxy.imzami.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Upstreams
    upstream backend_99 {
        random;
        server a.imzami.com:99 max_fails=3 fail_timeout=10s;
        server b.imzami.com:99 max_fails=3 fail_timeout=10s;
    }
    upstream backend_98 {
        random;
        server a.imzami.com:98 max_fails=3 fail_timeout=10s;
        server b.imzami.com:98 max_fails=3 fail_timeout=10s;
    }
    upstream backend_500 {
        random;
        server a.imzami.com:500 max_fails=3 fail_timeout=10s;
        server b.imzami.com:500 max_fails=3 fail_timeout=10s;
    }
    upstream backend_4500 {
        random;
        server a.imzami.com:4500 max_fails=3 fail_timeout=10s;
        server b.imzami.com:4500 max_fails=3 fail_timeout=10s;
    }

    # Servers for each port
    server {
        listen 99 ssl;
        server_name proxy.imzami.com;
        location / { proxy_pass http://backend_99; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    }
    server {
        listen 98 ssl;
        server_name proxy.imzami.com;
        location / { proxy_pass http://backend_98; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    }
    server {
        listen 500 ssl;
        server_name proxy.imzami.com;
        location / { proxy_pass http://backend_500; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    }
    server {
        listen 4500 ssl;
        server_name proxy.imzami.com;
        location / { proxy_pass http://backend_4500; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; }
    }
}
